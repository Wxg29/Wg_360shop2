(function(){function t(){function n(n){e=!0,t=setTimeout(r,n||2e3)}function r(){t&&(clearTimeout(t),t=null),e=!1}function i(){return e}var e=!1,t=null;return{lock:n,unlock:r,islock:i}}function n(e){var t=function(e){this.eleBox,this.eleList,this.elePoints,this.playLock=!1,this.playDuration=500,this.index=0,this.eleLength,this.autoplay=!0,this.playTime=5e3,this.init(e)};return t.prototype.play=function(){var e=this;this.autoPlayInterval=setInterval(function(){e.next()},e.playTime)},t.prototype.stop=function(){clearInterval(this.autoPlayInterval)},t.prototype.go=function(e){if(this.playLock)return;this.playLock=!0;var t=this,n=t.eleList.children().eq(e);n.fadeIn(t.playDuration),t.eleList.children().not(n).fadeOut(t.playDuration,function(){t.playLock=!1}),t.updatePoint(e),this.index=e},t.prototype.next=function(){this.go((this.index+1)%this.eleLength)},t.prototype.prev=function(){this.go((this.index+this.eleLength-1)%this.eleLength)},t.prototype.showBtnAndBind=function(){var e=this;e.eleBox.find(".slide-next").click(function(){return e.next(),!1}).show(),e.eleBox.find(".slide-prev").click(function(){return e.prev(),!1}).show(),e.elePoints.on("click","a",function(t){return e.go($(this).index()),!1}),e.eleBox.find(".slide-prev,.slide-next").mouseenter(function(){e.stop()}).mouseleave(function(){e.autoplay&&e.play()}),e.elePoints.mouseenter(function(){e.stop()}).mouseleave(function(){e.autoplay&&e.play()})},t.prototype.showPoint=function(){var e=[];for(var t=0;t<this.eleLength;t++)e.push('<a href="javascript:;"></a>');this.elePoints.html(e.join("")).show(),this.updatePoint(0)},t.prototype.updatePoint=function(e){this.elePoints.find("a").removeClass("curr-point").eq(e).addClass("curr-point")},t.prototype.init=function(e){this.eleBox=$(e.wrapper),this.autoplay=e.autoplay!==undefined?e.autoplay:this.autoplay,this.playTime=+e.playTime||this.playTime,this.eleList=this.eleBox.find(".slide-box"),this.elePoints=this.eleBox.find(".slide-point"),this.eleList.html(template("header-banner-tpl",e.tplData)),this.eleLength=this.eleList.find(".slider-film").length,this.eleList.children().first().show(),this.eleLength>1?(this.showPoint(),this.showBtnAndBind(),this.autoplay&&this.play()):this.eleBox.find(".slide-next,.slide-prev").hide()},e?new t({wrapper:".banner-box",tplData:e,autoplay:e.autoplay,playTime:e.playTime}):null}function r(){var e=function(e){this.categoryList=[],this.init(e),this.initLv1List()};return e.prototype.init=function(e){this.eleBox=$(e.wrapper),this.eleLv1Box=this.eleBox.find(e.wrapperLv1);for(var t in e)this[t]=e[t]},e.prototype.initLv1List=function(){var e=this;$.ajax({url:"/h5/getPrimaryCategory",dataType:"json",type:"get"}).done(function(t){if(t.errno==0){var n=t.data||{};e.typeConst=n.type;var r=n.category;for(var i=0;i<r.length&&i<10;i++){var s=r[i];e.categoryList.push({id:s.id,name:s.name,pic:s.pic,url:s.url,isLoaded:!1,isLoading:!1})}e.eleLv1Box.html(template(e.tplLv1,{list:e.categoryList}));var o="";e.eleLv1Box.children().each(function(t,n){var r=$(this),i=e.categoryList[t];i.$lv1=r,i.$lv2Box=r.find(e.wrapperLv2);var s=r.find(".left-item").width()+2;s>o&&(o=s)}),$("head").append("<style>.category-box .category-item .left-item{display: block;width:"+o+"px}"),e.addLoadLv2Event()}})},e.prototype.addLoadLv2Event=function(){var e=this;this.eleLv1Box.children().on("mouseenter",function(){var t=$(this).attr("data-index");e.loadLv2Data(t)})},e.prototype.loadLv2Data=function(e){var t=this,n=this.categoryList[e];if(n.isLoading)return!1;this.setLv2BoxText(e,"\u52a0\u8f7d\u4e2d..."),n.isLoading=!0,$.ajax({url:"/h5/getSecondaryCategory",dataType:"json",type:"get",data:{type:t.typeConst,id:n.id}}).done(function(r){n.isLoading=!1;if(r.errno==0){var i=r.data||{};i.indexL1=e,i.nameL1=n.name;if(i.secondary&&i.secondary.length){var s="",o="",u="";i.show_level=="2"?s=template(t.tplLv2,i):s=template(t.tplLv3,i),i.brand.length>0&&(o=template(t.brandBox,i));var a=i.spread&&i.spread.length;a?(u=template(t.tplAdBox,i),n.$lv2Box.removeClass(t.NoAdCls)):n.$lv2Box.addClass(t.NoAdCls),n.$lv2Box.html('<div class="category-left">'+s+o+"</div>"+u)}else t.setLv2BoxText(e,"\u6682\u65e0\u6570\u636e");n.isLoaded=!0,n.$lv1.off("mouseenter")}else t.setLv2BoxText(e,r.errmsg||"\u7f51\u7edc\u5f02\u5e38\uff0c\u8bf7\u91cd\u8bd5")}).fail(function(){t.setLv2BoxText(e,"\u7f51\u7edc\u5f02\u5e38\uff0c\u8bf7\u91cd\u8bd5"),n.isLoading=!1})},e.prototype.setLv2BoxText=function(e,t){var n=this.categoryList[e],r=n.$lv2Box;r.html(template("category-empty-tpl",{html:t}))},new e({wrapper:".category-box",wrapperLv1:".category-list",wrapperLv2:".right-wrapper",NoAdCls:"no-ad-mod",tplLv1:"category-lv1-tpl",tplLv2:"category-lv2-tpl",tplLv3:"category-lv3-tpl",tplAdBox:"category-ad-tpl",brandBox:"brand-tpl"})}function i(n){var r=function(e){this.floorList=[],this.eleBox=null,this.elevator=null,this.elevatorItemSelector=".elevator-item",this.isElevatorShow=!1,this.nextFloorId=0,this.floorTopOffset=60,this.curFloorIndex=null,this.init(e)};r.prototype.init=function(e){this.eleBox=$(e.wrapper),this.elevator=$(e.elevatorWrapper);var t=this.eleBox.offset&&this.eleBox.offset();this.boxTop=t&&t.top-100||600,this.eventInit(),this.scrollBind(),this.renderInitData(n)},r.prototype.eventInit=function(){var e=this;e.elevator.on("click",e.elevatorItemSelector,function(){var t=$(this),n=t.attr("data-index");return e.goFloor(n),e.refreshElevatorIndex(),!1})},r.prototype.scrollBind=function(){var e=this;$(window).on("scroll",function(){e.refreshElevatorIndex(),e.checkShowElevator()})},r.prototype.renderInitData=function(e){this.eleBox.html("");for(var t=0;t<e.length;t++){var n=e[t];n.floorIndex=t;var r="";switch(n.type){case"imgAd":case"productList":case"timeRush":case"tuan":case"bannerImgAd":r=n.type;break;case"video":case"article":r=n.type+"_list";break;case"feed":r="bottom_"+n.type}r="mod-"+r+"-tpl";var i=$(template(r,n));if(n.background){var s=n.background,o=n.backgroundUrl,u="background";s.trim&&(s=s.trim()),/^#[0-9a-fA-F]+$/.test(s)||(u="background-image",s="url("+qikoo.util.betterImg(s)+")"),n.background_size==0?i.css(u,s):(i.find(".floor-body").css(u,s),o&&(i.find(".floor-body").attr({"data-url":o}),i.find(".floor-body").addClass("jsModLink")))}this.eleBox.append(i),n.$floor=i,n.elevatorName=n.elevatorName||n.title,this.floorList.push(n)}this.refreshFloorsPosition(),this.setElevatorData(),this.refreshElevatorIndex(),this.checkShowElevator();var a={timeRush:"initModTimeRush",tuan:"initModTuan",video:"initModVideo",feed:"initModBottomFeed"};for(var t=0;t<this.floorList.length;t++){var f=this.floorList[t],l=a[f.type];l&&this[l](t)}},r.prototype.getFloorId=function(){return"mod_floor_"+this.nextFloorId++},r.prototype.goFloor=function(e){if(e<0||e>=this.floorList.length)return!1;var t=this.floorList[e];window.scrollTo(0,t.top-this.floorTopOffset)},r.prototype.setTopOffset=function(e){this.floorTopOffset=e},r.prototype.refreshFloorsPosition=function(){for(var e=0;e<this.floorList.length;e++){var t=this.floorList[e],n=t.$floor,r=n.offset(),i=n.height();t.top=r.top,t.bottom=r.top+i}},r.prototype.getNewFloorIndex=function(){var e=window.scrollY||document.documentElement.scrollTop,t=0,n=this.floorList.length;for(var r=this.floorList.length-1;r>=0;r--){var i=this.floorList[r];if(!i.elevatorShow)continue;if(i.top<e){t=n;break}n=r}return t==this.floorList.length&&(t=this.floorList.length-1),t},r.prototype.setElevatorData=function(){this.elevator.html(template("floor-elevator-list",{list:this.floorList}))},r.prototype.setElevatorIndex=function(e){this.elevator.find(this.elevatorItemSelector).removeClass("current").filter('[data-index="'+e+'"]').addClass("current")},r.prototype.refreshElevatorIndex=function(e){var t=this.getNewFloorIndex();if(e||t!==this.curFloorIndex)this.curFloorIndex=t,this.setElevatorIndex(t);if(t==this.floorList.length-1){var n=$(document).height()-$(".mod-footer").height()-$(".qikoo-top-box").height()-$(".index-header").height()-$(".index-elevator-box").height(),r=$(document).height()-$(".mod-footer").height()-$(".qikoo-top-box").height()-$(".index-header").height()+$(".index-elevator-box").height()/2;window.scrollY>r?$(".index-elevator-box").css({position:"absolute",top:n+"px"}):$(".index-elevator-box").css({position:"fixed",top:"50%"})}},r.prototype.checkShowElevator=function(){var e=window.scrollY||document.documentElement.scrollTop;e>this.boxTop&&!this.isElevatorShow?(this.elevator.addClass("show"),this.isElevatorShow=!0):e<this.boxTop&&this.isElevatorShow&&(this.elevator.removeClass("show"),this.isElevatorShow=!1)},r.prototype.initModTimeRush=function(e){function u(){$.ajax({url:"/appRush/hall",dataType:"json",type:"get"}).done(function(e){if(e.errno==0){var t=e.data;t=t&&t.tabs,t=t&&t.length&&t[0];var n=t&&t.content&&t.content.items||[];if(!t||!n.length)return a(),!1;i.find(".js_title").text(t.title+"\u573a"),i.find(".js_cd_prev").text(t.remain_prefix),f(t.remain||0),r.find(".floor-item-box").html(template("mod-timeRush-item-tpl",{list:n,status:t.status}))}else a()}).fail(a)}function a(){for(var i=0;i<t.floorList.length;i++)if(t.floorList[i]==n){e=i;break}r.remove(),t.floorList.splice(e,1),t.refreshFloorsPosition(),t.setElevatorData(),t.refreshElevatorIndex(!0)}function f(e){function i(e){var r=+(new Date),i=Math.floor((t-r)/1e3);if(i<0)return u(),n&&clearInterval(n),e&&s.hide(),!1;a(i),e&&s.show()}function a(e){if(r.left===e)return!1;r.left=e;if(e<0)return!1;var t=qikoo.util.timeFillZero(Math.floor(e/3600)),n=qikoo.util.timeFillZero(Math.floor(e%3600/60)),i=qikoo.util.timeFillZero(Math.floor(e%60));return i!==r.second&&(o.eq(2).text(i),r.second=i),n!==r.min&&(o.eq(1).text(n),r.min=n),t!==r.hour&&(o.eq(0).text(t),r.hour=t),!0}var t=+(new Date)+e*1e3,n=null,r={left:null,hour:o.eq(0).text(),min:o.eq(1).text(),second:o.eq(2).text()};n=setInterval(function(){i(!1)},200),i(!0)}var t=this,n=t.floorList[e],r=n.$floor,i=r.find(".floor-title"),s=i.find(".countdown-box"),o=s.find(".countdown-time");u()},r.prototype.initModTuan=function(e){function o(){var e=[],t=n.data.list||[];for(var r=0;r<t.length;r++){var i=t[r];i&&i.itemId&&$.inArray(i.itemId,e)==-1&&e.push(i.itemId)}$.ajax({url:"/tuan/listbyhotitems",data:{size:s,hot_items:e.join("|")}}).done(function(e){if(e.errno==0){if(!e.data||!e.data.length)return u(),!1;a(e.data),f()}else u()}).fail(u)}function u(){for(var i=0;i<t.floorList.length;i++)if(t.floorList[i]==n){e=i;break}r.remove(),t.floorList.splice(e,1),t.refreshFloorsPosition(),t.setElevatorData(),t.refreshElevatorIndex(!0)}function a(e){var t=n.data.list||[],r=[];for(var s=0;s<e.length;s++){var o=e[s],u={};for(var a=0;a<t.length;a++){var f=t[a];if(o.item_id==f.itemId){u=f;break}}r.push({itemId:o.item_id,pic:u.pic||o.item_img,title:u.title||o.item_title,desc:u.desc||"",tuanPrice:u.tuanPrice||o.tuan_price/100,originPrice:u.originPrice||o.sale_price,label:u.label||o.tuan_tag+"\u4eba\u56e2",goingList:o.participate_user})}i.find(".floor-item-box").html(template("mod-tuan-item-tpl",{list:r}))}function f(){i.find(".item-qrcode").each(function(){try{var e=$(this),t=e.attr("data-qrcode");t?e.qrcode({width:160,height:160,text:t}).show():e.hide()}catch(n){console.log(n)}})}var t=this,n=t.floorList[e],r=n.$floor,i=r.find(".floor-body"),s=2;o()},r.prototype.initTuanRandomAvatarList=function(e){var t=[],n=e.data.list,r=+(new Date),i=String(r).split("").reverse(),s=+i[6]%2==0,o=(+i[s?4:5]+1)%9,u=(+i[s?5:4]+1)%9,i=i.splice(o,u).concat(i),a=i.length,f=[],l=[];for(var c=0;c<o;c++)f.push({avatar:t[i[c%a]]});for(var c=0;c<u;c++)l.push({avatar:t[i[(a-1-c)%a]]});n[0].tuanList=f,n[1].tuanList=l},r.prototype.initModVideo=function(e){function o(e){var t=null,n=$(template("index-video-tpl",{title:e.title}));$(body).append(n),n.addClass("show"),setTimeout(function(){n.find(".icon-close").on("click",function(){return n.removeClass("show"),t&&t.pause&&t.pause(),setTimeout(function(){t&&t.destroy&&t.destroy(),n.remove()},300),!1})},300),t=new ChimeePlayer({wrapper:"#index-video-box",src:e.videoSrc,poster:e.poster,autoplay:!0,controls:!1})}var t=this,n=this.floorList[e],r=n.$floor,i=r.find(".floor-body"),s=i.find(".video-box");qikoo.browser.msie&&s.find(".icon-play").hide(),s.on("click",function(){var e=$(this);return!qikoo.browser.msie&&window.ChimeePlayer?o({title:e.attr("data-title")||"\u89c6\u9891",videoSrc:e.attr("data-src"),poster:e.find("img").attr("src")}):window.open(e.attr("data-url")),!1}),$.getScript("https://lib.baomitu.com/chimee-player/1.4.7/chimee-player.browser.js")},r.prototype.initModBottomFeed=function(n){function v(e){if(c.islock())return!1;c.lock(),f.text(l.loading),$.ajax({url:location.protocol+"//search.mall.360.cn/search/latest",dataType:"jsonp",type:"get",data:{q:"*",size:d,page:e,_:+(new Date)}}).done(function(t){c.unlock();if(t&&t.errno==0){h=e;var n=t.data,i=$(template("feed-list-tpl",n));e==p?u.html(i):u.append(i),qikoo.util.itemImgDefault(i.find(".item-img img")),n.total>(e+1)*d?(f.text(l.next),a.hide()):(f.hide(),a.text("\u6211\u5df2\u7ecf\u966a\u4f60\u5230\u5e95\u4e86").show(),$(window).off("scroll",g)),r.refreshFloorsPosition()}else e==p&&a.text(t&&t.errmsg||"\u7f51\u7edc\u5f02\u5e38").show(),f.text(l.retry)}).fail(function(){c.unlock(),e==p&&a.text("\u7f51\u7edc\u5f02\u5e38").show(),f.text(l.retry)})}function m(){f.on("click",function(){return h===null?v(p):v(h+1),!1}),$(body).on("click",".jsModLink",function(e){e.stopPropagation();var t=$(this).attr("data-url");window.open(t)}).on("click",".jsModLink .floor-box",function(e){e.stopPropagation()}),$(window).on("scroll",g)}function g(){if(c.islock())return!1;var t=window.scrollY||document.documentElement.scrollTop;t>=i.bottom-e-500&&f.trigger("click")}var r=this,i=this.floorList[n],s=i.$floor,o=s.find(".floor-body"),u=o.find(".feed-list"),a=o.find(".feed-bottom-text"),f=o.find(".feed-more-btn"),l={next:"\u70b9\u51fb\u52a0\u8f7d\u66f4\u591a",loading:"\u52a0\u8f7d\u4e2d...",retry:"\u70b9\u51fb\u91cd\u8bd5"},c=new t,h=null,p=0,d=20;m()};var i=new r({wrapper:".index-floor",elevatorWrapper:".index-elevator-box"});return i}function s(){function s(){$.ajax({url:"/h5/eventpopup",type:"post",dataType:"json"}).done(function(e){if(e.errno==0){var t=e.data;if(!t||!t.data)return!1;switch(e.data.tag){default:case"promote":var r=t.data;if(!r)return!1;u(t.data.pic),n.on("click",function(e){return e.preventDefault(),location.href=t.data.url,!1});break;case"newusercoupon":var r=t.data.coupons;if(!r)return!1;r.length>0&&u(t.data.pic),n.on("click",function(e){return e.preventDefault(),a(r),!1})}}})}function o(){i.hide(),t.hide(),e.hide()}function u(r){var s=new Image;s.onload=function(){var r=s.width/2,o=s.height/2;$(".activity-coupon").css({width:r+"px",height:o+"px",marginLeft:-r/2+"px",marginTop:-o/2+"px"});var u="<img src="+s.src+">";n.html(u),e.show(),setTimeout(function(){e.addClass("activity-coupon-visible")},0),t.show(),i.show()},s.src=r}function a(r){var i=[];for(var s=0;s<r.length;s++)i.push(r[s].coupon_id);$.ajax({url:"coupon/take",type:"post",dataType:"json",data:{newusercoupon:1,coupon:i.join(","),_:+(new Date)}}).done(function(i){if(i.errno==0){var s=i.data.usedMap;for(var u=0;u<r.length;u++)r[u].can_use=s[r[u].coupon_id].can_use;var a=template("activity-list-tpl",{list:r});t.find("ul").html(a),e.hide(),t.addClass("activity-list-visible")}else i.errno==1?QHPass.signIn(function(){n.trigger("click")}):qikoo.dialog.alert(i.errmsg).find(".console-btn-confirm").text("\u77e5\u9053\u4e86").click(function(){return o(),!1})})}var e=$(".activity-coupon"),t=$(".activity-coupon-list"),n=$(".activity-coupon-btn"),r=$(".activity-close"),i=$(".activity-bg");r.on("click",function(e){return e.preventDefault(),o(),!1}),s()}function o(){template.helper("betterImg",qikoo.util.betterImg),template.helper("formatDate",qikoo.util.formatDate),template.helper("publishTime",qikoo.util.publishTime),template.helper("num2percent",qikoo.util.num2percent),template.helper("itemHref",qikoo.util.itemHref)}function u(){$(window).on("resize",function(){e=$(window).height()}),e=$(window).height()}function a(){$.ajax({url:"/skin/container",dataType:"json",type:"get",data:{v:qikoo.getUrlParam("test_preview")}}).done(function(e){e.errno==0&&e.data?f(e.data):f()}).fail(function(){f()})}function f(e){var t=e&&e.frames||{},r=e&&e.floors||[];c=i(r),n(t.banner),l&&l.renderData(t),qikoo.top&&(qikoo.top.onRefreshTopHeight(function(e){c&&(c.refreshFloorsPosition(),c.setTopOffset(e))}),qikoo.top.renderTopBanner(t.topAd))}function h(){o(),u(),r(),a(),s(),qikoo.header&&(l=new qikoo.header.Header({wrapper:".index-header",windowOpen:!0,autoGetData:!1}))}var e,l=null,c=null;$(h)})();